<html>
    <head>
        <title>
            Demo
        </title>

        <script src="/jquery-1.11.3.min.js"></script>
        <script src="/jquery-ui.min.js"></script>
        <script src="/socket.io-1.3.5.js"></script>
        <script>
            console.log('I am working!');
            var isDrawing = false;
            var prevX, prevY, currX, currY;
            var size = 25;
            var track = [];
            function drawCircle (ctx, centerX, centerY, radius) {
                // use circle to smooth out the path
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
                ctx.fillStyle = 'black';
                ctx.fill();
                ctx.closePath();
            }
            function draw (ctx, x1, y1, x2, y2) {
                // draw line
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.fillStyle = 'black';
                ctx.lineWidth = size;
                ctx.stroke();
                ctx.closePath();

                drawCircle(ctx, x2, y2, size/2);
            }

            var socket = io();

            $(document).ready(function() {
                var board = $('#board');
                var ctx = board[0].getContext('2d');
                var height = board.height();
                var width = board.width();
                
                var recBoard = $('#board2');
                var recCtx = recBoard[0].getContext('2d');;
                var height = recBoard.height();
                var width = recBoard.width();
                
                board.mousedown(function(e) {
                    currX = e.offsetX;
                    currY = e.offsetY;
                    track.push([currX, currY]);
                    isDrawing = true;
                    drawCircle(ctx, currX, currY, size/2);
                });
                board.mousemove(function(e) {
                    if (isDrawing) {
                        prevX = currX;
                        prevY = currY;
                        currX = e.offsetX;
                        currY = e.offsetY;
                        draw(ctx, prevX, prevY, currX, currY);
                        track.push([currX, currY]);
                    }
                });
                board.mouseup(function() {
                    isDrawing = false;
                    currX = undefined;
                    currY = undefined;
                    prevX = undefined;
                    prevY = undefined;
                    
                    socket.emit('draw', JSON.stringify(track));
                    track = [];
                });
                
                socket.on('draw', function(msg) {
                    var toDraw = JSON.parse(msg);
                    if (toDraw.length === 1) {
                        drawCircle(recCtx, toDraw[0][0], toDraw[0][1], size/2);
                        return;
                    }
                    var start = toDraw.splice(0, 1)[0];
                    toDraw.forEach(function(point) {
                        draw(recCtx, start[0], start[1], point[0], point[1]);
                        start = point;
                    });
                });
            });
        </script>
    </head>
    <body>
        <canvas id="board" width="400" height="400" style="position:absolute;top:10%;left:10%;border:2px solid black;"></canvas>
        <canvas id="board2" width="400" height="400" style="position:absolute;bottom:10%;right:10%;border:2px solid chocolate;"></canvas>

    </body>
</html>